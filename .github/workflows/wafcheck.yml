name: Internal CWAAF IP Health Check with Combined Results

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Full URL (https://host/path). Example: https://app.example.com/hc"
        required: true
        type: string
      ip:
        description: "Target IP to force-connect to (CWAAF IP). Example: 203.0.113.10"
        required: true
        type: string
      seconds:
        description: "How many seconds to run"
        required: false
        default: "10"
        type: string
      interval_ms:
        description: "Interval between requests (ms)"
        required: false
        default: "1000"
        type: string
      insecure_tls:
        description: "Skip TLS verification (-k). Use true if cert/SNI mismatch is expected."
        required: false
        default: "false"
        type: string
      fail_threshold_pct:
        description: "Optional: fail workflow if error rate exceeds this percent"
        required: false
        default: "100"
        type: string

jobs:
  hc_test:
    name: Run HC Test on Multiple Agents
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      max-parallel: 3
      matrix:
        agent: [1, 2, 3, 4, 5]

    steps:
      - name: Show runner public IP + country
        shell: bash
        run: |
          set -euo pipefail
          RUNNER_IP="$(curl -s https://api.ipify.org || true)"
          RUNNER_COUNTRY="$(curl -s https://ipinfo.io/country || true)"
          echo "Runner public IP: ${RUNNER_IP}"
          echo "Runner country: ${RUNNER_COUNTRY}"
          echo "RUNNER_IP=${RUNNER_IP}" >> "$GITHUB_ENV"
          echo "RUNNER_COUNTRY=${RUNNER_COUNTRY}" >> "$GITHUB_ENV"

      - name: Run HC test with --resolve
        shell: bash
        env:
          URL: ${{ inputs.url }}
          IP: ${{ inputs.ip }}
          DURATION: ${{ inputs.seconds }}
          INTERVAL_MS: ${{ inputs.interval_ms }}
          INSECURE_TLS: ${{ inputs.insecure_tls }}
          AGENT: ${{ matrix.agent }}
          FAIL_THRESHOLD: ${{ inputs.fail_threshold_pct }}
          RUNNER_IP: ${{ env.RUNNER_IP }}
          RUNNER_COUNTRY: ${{ env.RUNNER_COUNTRY }}
        run: |
          set -euo pipefail

          # Input validation
          if ! [[ "$DURATION" =~ ^[0-9]+$ ]]; then echo "Invalid seconds value"; exit 1; fi
          if ! [[ "$INTERVAL_MS" =~ ^[0-9]+$ ]]; then echo "Invalid interval_ms value"; exit 1; fi
          if ! [[ "$IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]]; then echo "Invalid IPv4 format"; exit 1; fi

          # Parse host from URL
          host="$(echo "$URL" | sed -E 's#^https?://([^/:]+).*#\1#')"
          proto="$(echo "$URL" | sed -E 's#^(https?).*#\1#')"
          if [ "$proto" != "https" ]; then echo "Only https supported"; exit 1; fi
          port="443"

          echo "agent=$AGENT url=$URL host=$host ip=$IP duration=${DURATION}s interval_ms=$INTERVAL_MS insecure_tls=$INSECURE_TLS runner_ip=${RUNNER_IP:-} runner_country=${RUNNER_COUNTRY:-}"

          result_file="results_agent_${AGENT}.csv"
          echo "ts,agent,runner_ip,runner_country,http_code,remote_ip,ssl_verify_result,time_connect,time_appconnect,time_starttransfer,time_total" > "$result_file"

          start_epoch="$(date +%s)"
          end_epoch="$((start_epoch + DURATION))"
          count=0
          errors=0

          while [ "$(date +%s)" -lt "$end_epoch" ]; do
            ts="$(date -Is)"
            count=$((count+1))

            curl_args=(
              -sS
              -o /dev/null
              --connect-timeout 5
              --max-time 15
              --resolve "${host}:${port}:${IP}"
              -H "User-Agent: Internal-HC-Agent-${AGENT}"
              -w "%{http_code},%{remote_ip},%{ssl_verify_result},%{time_connect},%{time_appconnect},%{time_starttransfer},%{time_total}"
              "$URL"
            )

            if [ "$INSECURE_TLS" = "true" ] || [ "$INSECURE_TLS" = "1" ]; then
              curl_args=(-k "${curl_args[@]}")
            fi

            out="$(curl "${curl_args[@]}" 2>&1)"
            rc=$?
            if [ $rc -ne 0 ]; then
              out="curl_error_${rc},0,0,0,0,0,0"
              errors=$((errors+1))
            fi

            echo "${ts},${AGENT},${RUNNER_IP:-},${RUNNER_COUNTRY:-},${out}" | tee -a "$result_file" >/dev/null

            # Sleep with optional jitter
            jitter=$(shuf -i 0-200 -n 1)
            sleep "$(awk "BEGIN {print ($INTERVAL_MS + $jitter)/1000}")"
          done

          echo "Agent $AGENT finished. Total requests: $count, Total errors: $errors"

          # Optional fail threshold
          error_rate=$((errors * 100 / count))
          echo "Error rate: ${error_rate}%"
          if [ "$error_rate" -gt "$FAIL_THRESHOLD" ]; then
            echo "Error rate exceeds threshold (${FAIL_THRESHOLD}%)"
            exit 1
          fi

      - name: Upload per-agent results
        uses: actions/upload-artifact@v4
        with:
          name: hc-results-agent-${{ matrix.agent }}
          path: results_agent_${{ matrix.agent }}.csv

  merge_results:
    name: Merge All Agent Results
    runs-on: ubuntu-latest
    needs: hc_test
    steps:
      - name: Download all agent artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Merge CSVs into single file
        shell: bash
        run: |
          set -euo pipefail
          output="hc-results-combined.csv"

          # Keep header from first CSV
          first_csv=$(ls artifacts | head -n1)
          head -n1 "artifacts/$first_csv" > "$output"

          # Append all CSVs excluding their headers
          for f in artifacts/*.csv; do
            tail -n +2 "$f" >> "$output"
          done

          echo "Merged CSV created: $output"

      - name: Upload merged results
        uses: actions/upload-artifact@v4
        with:
          name: hc-results-combined
          path: hc-results-combined.csv
