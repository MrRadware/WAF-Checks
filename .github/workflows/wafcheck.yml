name: CWAAF HC (10s) via IP override

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Full URL (https://host/path). Example: https://app.example.com/hc"
        required: true
        type: string
      ip:
        description: "Target IP to force-connect to (CWAAF IP). Example: 203.0.113.10"
        required: true
        type: string
      seconds:
        description: "How many seconds to run"
        required: false
        default: "10"
        type: string
      interval_ms:
        description: "Interval between requests (ms)"
        required: false
        default: "1000"
        type: string
      insecure_tls:
        description: "Skip TLS verification (-k). Use true if cert/SNI mismatch is expected."
        required: false
        default: "true"
        type: string

jobs:
  hc_test:
    name: Run from multiple agents
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        agent: [1, 2, 3, 4, 5]  # שנה ל-10 אם בא לך

    steps:
      - name: Show runner public IP + country (and export)
        shell: bash
        run: |
          set -euo pipefail
          RUNNER_IP="$(curl -s https://api.ipify.org || true)"
          RUNNER_COUNTRY="$(curl -s https://ipinfo.io/country || true)"
          RUNNER_GEO_JSON="$(curl -s https://ipinfo.io || true)"

          echo "Runner public IP: ${RUNNER_IP}"
          echo "Runner country:   ${RUNNER_COUNTRY}"
          echo "Runner geo:"
          echo "${RUNNER_GEO_JSON}"

          # Make available to next steps
          echo "RUNNER_IP=${RUNNER_IP}" >> "$GITHUB_ENV"
          echo "RUNNER_COUNTRY=${RUNNER_COUNTRY}" >> "$GITHUB_ENV"

      - name: Run HC test with --resolve (no DNS)
        shell: bash
        env:
          URL: ${{ inputs.url }}
          IP: ${{ inputs.ip }}
          DURATION: ${{ inputs.seconds }}
          INTERVAL_MS: ${{ inputs.interval_ms }}
          INSECURE_TLS: ${{ inputs.insecure_tls }}
          AGENT: ${{ matrix.agent }}
        run: |
          set -euo pipefail

          # Parse host from URL (expects https://host/path)
          host="$(echo "$URL" | sed -E 's#^https?://([^/:]+).*#\1#')"
          proto="$(echo "$URL" | sed -E 's#^(https?).*#\1#')"
          if [ "$proto" != "https" ]; then
            echo "Only https is supported. Got: $proto"
            exit 1
          fi

          port="443"

          echo "agent=$AGENT url=$URL host=$host ip=$IP duration=${DURATION}s interval_ms=$INTERVAL_MS insecure_tls=$INSECURE_TLS runner_ip=${RUNNER_IP:-} runner_country=${RUNNER_COUNTRY:-}"

          echo "ts,agent,runner_ip,runner_country,http_code,remote_ip,ssl_verify_result,time_connect,time_appconnect,time_starttransfer,time_total" \
            > "results_agent_${AGENT}.csv"

          start_epoch="$(date +%s)"
          end_epoch="$((start_epoch + DURATION))"

          while [ "$(date +%s)" -lt "$end_epoch" ]; do
            ts="$(date -Is)"

            curl_args=(-sS -o /dev/null
              --resolve "${host}:${port}:${IP}"
              -w "%{http_code},%{remote_ip},%{ssl_verify_result},%{time_connect},%{time_appconnect},%{time_starttransfer},%{time_total}"
              "$URL"
            )

            if [ "$INSECURE_TLS" = "true" ] || [ "$INSECURE_TLS" = "1" ]; then
              curl_args=(-k "${curl_args[@]}")
            fi

            out="$(curl "${curl_args[@]}" 2>/dev/null || echo "curl_error,0,0,0,0,0,0")"
            echo "${ts},${AGENT},${RUNNER_IP:-},${RUNNER_COUNTRY:-},${out}" | tee -a "results_agent_${AGENT}.csv" >/dev/null

            python3 -c "import time; time.sleep(int('$INTERVAL_MS')/1000)"
          done

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: hc-results-agent-${{ matrix.agent }}
          path: results_agent_${{ matrix.agent }}.csv
