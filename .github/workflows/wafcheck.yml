name: Internal CWAAF IP Health Check

on:
  workflow_dispatch:
    inputs:
      url:
        description: "Full URL (https://host/path). Example: https://app.example.com/hc"
        required: true
        type: string
      ip:
        description: "Target IP to force-connect to (CWAAF IP). Example: 203.0.113.10"
        required: true
        type: string
      num_probes:
        description: "How many probes to run (1-5)"
        required: true
        default: "3"
        type: choice
        options:
          - "1"
          - "2"
          - "3"
          - "4"
          - "5"
      seconds:
        description: "How many seconds to run"
        required: false
        default: "10"
        type: string
      interval_ms:
        description: "Interval between requests (ms)"
        required: false
        default: "1000"
        type: string
      insecure_tls:
        description: "Skip TLS verification (-k)"
        required: false
        default: "false"
        type: string
      fail_threshold_pct:
        description: "Fail workflow if error rate exceeds this percent"
        required: false
        default: "100"
        type: string

jobs:
  hc_test:
    name: HC Test - Agent ${{ matrix.agent }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      max-parallel: 5
      matrix:
        agent: [1, 2, 3, 4, 5]

    steps:
      # ----------------------------------------------------
      # Decide whether this agent should run
      # ----------------------------------------------------
      - name: Determine if this agent should run
        id: probe_check
        shell: bash
        run: |
          SELECTED="${{ inputs.num_probes }}"
          CURRENT="${{ matrix.agent }}"

          if [ "$CURRENT" -le "$SELECTED" ]; then
            echo "run_probe=true" >> $GITHUB_OUTPUT
          else
            echo "run_probe=false" >> $GITHUB_OUTPUT
          fi

      # ----------------------------------------------------
      # Show runner IP (only if selected)
      # ----------------------------------------------------
      - name: Show runner public IP + country
        if: steps.probe_check.outputs.run_probe == 'true'
        shell: bash
        run: |
          RUNNER_IP="$(curl -s https://api.ipify.org || echo unknown)"
          RUNNER_COUNTRY="$(curl -s https://ipinfo.io/country || echo unknown)"
          echo "Runner public IP: ${RUNNER_IP}"
          echo "Runner country: ${RUNNER_COUNTRY}"
          echo "RUNNER_IP=${RUNNER_IP}" >> "$GITHUB_ENV"
          echo "RUNNER_COUNTRY=${RUNNER_COUNTRY}" >> "$GITHUB_ENV"

      # ----------------------------------------------------
      # Run Health Check
      # ----------------------------------------------------
      - name: Run HC test with --resolve
        if: steps.probe_check.outputs.run_probe == 'true'
        shell: bash
        env:
          URL: ${{ inputs.url }}
          IP: ${{ inputs.ip }}
          DURATION: ${{ inputs.seconds }}
          INTERVAL_MS: ${{ inputs.interval_ms }}
          INSECURE_TLS: ${{ inputs.insecure_tls }}
          AGENT: ${{ matrix.agent }}
          FAIL_THRESHOLD: ${{ inputs.fail_threshold_pct }}
          RUNNER_IP: ${{ env.RUNNER_IP }}
          RUNNER_COUNTRY: ${{ env.RUNNER_COUNTRY }}
        run: |

          # Basic validation
          [[ "$DURATION" =~ ^[0-9]+$ ]] || { echo "Invalid seconds"; exit 1; }
          [[ "$INTERVAL_MS" =~ ^[0-9]+$ ]] || { echo "Invalid interval_ms"; exit 1; }
          [[ "$IP" =~ ^[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+$ ]] || { echo "Invalid IPv4"; exit 1; }

          host="$(echo "$URL" | sed -E 's#^https?://([^/:]+).*#\1#')"
          proto="$(echo "$URL" | sed -E 's#^(https?).*#\1#')"
          [ "$proto" = "https" ] || { echo "Only https supported"; exit 1; }
          port="443"

          result_file="results_agent_${AGENT}.csv"
          echo "ts,agent,runner_ip,runner_country,http_code,remote_ip,ssl_verify_result,time_connect,time_appconnect,time_starttransfer,time_total" > "$result_file"

          start_epoch="$(date +%s)"
          end_epoch=$((start_epoch + DURATION))

          count=0
          errors=0

          while [ "$(date +%s)" -lt "$end_epoch" ]; do
            ts="$(date -Is)"
            count=$((count+1))

            curl_args=(
              -sS
              -o /dev/null
              --connect-timeout 5
              --max-time 15
              --resolve "${host}:${port}:${IP}"
              -H "User-Agent: Internal-HC-Agent-${AGENT}"
              -w "%{http_code},%{remote_ip},%{ssl_verify_result},%{time_connect},%{time_appconnect},%{time_starttransfer},%{time_total}"
              "$URL"
            )

            if [ "$INSECURE_TLS" = "true" ] || [ "$INSECURE_TLS" = "1" ]; then
              curl_args=(-k "${curl_args[@]}")
            fi

            out="$(curl "${curl_args[@]}" 2>/dev/null)"
            rc=$?

            if [ $rc -ne 0 ]; then
              out="curl_error,0,0,0,0,0,0"
              errors=$((errors+1))
            else
              http_code="$(echo "$out" | cut -d',' -f1)"
              if [[ "$http_code" -ge 400 ]] || [[ "$http_code" -eq 000 ]]; then
                errors=$((errors+1))
              fi
            fi

            echo "${ts},${AGENT},${RUNNER_IP:-},${RUNNER_COUNTRY:-},${out}" >> "$result_file"

            sleep "$(awk "BEGIN {print $INTERVAL_MS/1000}")"
          done

          if [ "$count" -eq 0 ]; then
            echo "No requests executed"
            exit 1
          fi

          error_rate=$((errors * 100 / count))
          echo "Agent $AGENT finished"
          echo "Total requests: $count"
          echo "Total errors: $errors"
          echo "Error rate: ${error_rate}%"

          if [ "$error_rate" -gt "$FAIL_THRESHOLD" ]; then
            echo "Error rate exceeds threshold (${FAIL_THRESHOLD}%)"
            exit 1
          fi

      # ----------------------------------------------------
      # Upload Results
      # ----------------------------------------------------
      - name: Upload per-agent results
        if: steps.probe_check.outputs.run_probe == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: hc-results-agent-${{ matrix.agent }}
          path: results_agent_${{ matrix.agent }}.csv
